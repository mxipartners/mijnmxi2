!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-selection"),require("d3-transition")):"function"==typeof define&&define.amd?define(["exports","d3-selection","d3-transition"],e):e((t=t||self).d3=t.d3||{},t.d3,t.d3)}(this,function(t,l,e){"use strict";var r="data-d3t7s";function n(t){this.selectorId=n.generateUniqueSelectorId(t),this.selector="["+r+'="'+this.selectorId+'"]'}var i=0;n.generateUniqueSelectorId=function(t){var e=t.attr(r);return e||(e=i.toString(36),i++,t.attr(r,e)),e},n.prototype.resolve=function(t){return t.attr(r)===this.selectorId?t:t.selectAll(this.selector)};function o(){return this.children}var h="data-d3t7b",a="1";function p(t){this.templatePath=new n(t),this.childNodes=[],this.renderers=[],t.attr(h,a),t.property("__d3t7tn__")||t.property("__d3t7tn__",this)}function u(t,e,r){p.call(this,t),this.dataFunction=e,this.childElement=r,this.storedEventHandlers=[]}function c(t,e,r){u.call(this,t,e,r)}function d(t,e,r){u.call(this,t,e,r)}function f(t,e,r){u.call(this,t,e,r)}function m(t,e,r){u.call(this,t,e,r)}function s(t,e){this.templatePath=new n(t),this.dataFunction=e}function v(t,e){s.call(this,t,e)}function y(t,e,r){s.call(this,t,e),this.attribute=r}function g(t,e,r){s.call(this,t,e),this.style=r}function _(t,e,r){s.call(this,t,e),this.property=r}p.isTemplateNode=function(t){return!!t.node().__d3t7tn__},p.getTemplateNode=function(t){for(var e=t.node();e&&!e.__d3t7tn__;)e=e.parentNode;return e?e.__d3t7tn__:null},p.copyDataToChildren=function(t,e){arguments.length<2&&(e=t.__data__);for(var r=t.children,n=0;n<r.length;n++)r[n].__data__=e,r[n].hasAttribute(h)||p.copyDataToChildren(r[n],e)},p.applyEventHandlersToSelection=function(t,e){if(t&&0!==t.length){var r=e.selectAll?e:l.select(e);t.forEach(function(t){var e=t.type;t.name&&(e+="."+t.name),r.on(e,t.value,t.capture)})}},p.prototype.resolveTemplateElements=function(t){return this.templatePath.resolve(t)},p.prototype.addChildNode=function(t){this.childNodes.push(t)},p.prototype.addRenderer=function(t){this.renderers.push(t)},p.prototype.renderData=function(t,e,r){return e.datum(t),this.joinData(e).render(e,r),this},p.prototype.joinData=function(e){return p.copyDataToChildren(e.node()),this.childNodes.forEach(function(t){t.joinData(e)}),this},p.prototype.render=function(t,e){var r=this.resolveTemplateElements(t);return this.renderers.forEach(function(t){t.render(r,e)}),this.renderNodes(r,e),this},p.prototype.renderNodes=function(e,r){return this.childNodes.forEach(function(t){t.render(e,r)}),this},((u.prototype=Object.create(p.prototype)).constructor=u).cloneChildNode=function(t){var e=t.cloneNode(!0);return e.removeAttribute("id"),e},u.prototype.getDataFunction=function(){return this.dataFunction},u.prototype.joinData=function(t){if(0===this.childElement.size())return this;var e=this.createDOMStructure(t,function(){var t=this.childElement.node(),e=u.cloneChildNode(t);t.__d3t7tn__&&(e.__d3t7tn__=t.__d3t7tn__);var r=this.childNodes;return l.select(e).selectAll("["+h+"]").each(function(t,e){this.__d3t7tn__=r[e]}),e});return e.each(function(){p.copyDataToChildren(this)}),this.childNodes.forEach(function(t){t.joinData(e)}),this},u.prototype.createDOMStructure=function(t,e){var r=this.resolveTemplateElements(t).selectAll(o).data(this.getDataFunction()),n=this,i=r.enter().append(function(){return e.call(n)});return this.applyEventHandlers(i),r.exit().remove(),i.merge(r)},u.prototype.storeEventHandlers=function(t){var e=t.node().__on;e&&0<e.length&&this.storedEventHandlers.push({templatePath:new n(t),eventHandlers:e});var r=this;return t.selectAll(o).each(function(){var t=l.select(this);r.storeEventHandlers(t)}),this},u.prototype.applyEventHandlers=function(n){return 0===n.size()||this.storedEventHandlers.forEach(function(t){var e=t.templatePath.resolve(n),r=t.eventHandlers;p.applyEventHandlersToSelection(r,e)}),this},u.prototype.renderNodes=function(t,e){var r=t.selectAll(o);return this.childNodes.forEach(function(t){t.render(r,e)}),this},(c.prototype=Object.create(u.prototype)).constructor=c,((d.prototype=Object.create(u.prototype)).constructor=d).prototype.getDataFunction=function(){var n=this;return function(t,e,r){return u.prototype.getDataFunction.call(n).call(this,t,e,r)?[t]:[]}},((f.prototype=Object.create(u.prototype)).constructor=f).prototype.getDataFunction=function(){var n=this;return function(t,e,r){return[u.prototype.getDataFunction.call(n).call(this,t,e,r)]}},((m.prototype=Object.create(u.prototype)).constructor=m).prototype.getDataFunction=f.prototype.getDataFunction,m.prototype.joinData=function(t){var c=this;return this.resolveTemplateElements(t).each(function(t,e,r){var n=l.select(this),i=c.childElement.call(this,t,e,r),o=(i.selectAll?i:l.select(i)).node(),a=o.__d3t7tn__;this.firstElementChild&&this.firstElementChild.__d3t7tn__!==a&&this.removeChild(this.firstElementChild);var s=c.createDOMStructure(n,function(){var t=u.cloneChildNode(o),r=(t.__d3t7tn__=a).childNodes;l.select(t).selectAll("["+h+"]").each(function(t,e){this.__d3t7tn__=r[e]}),p.applyEventHandlersToSelection(o.__on,t);var e=l.select(o).selectAll("*").nodes(),n=l.select(t).selectAll("*").nodes();return e.forEach(function(t,e){p.applyEventHandlersToSelection(t.__on,n[e])}),t});a.joinData(s)}),this},m.prototype.render=function(t,r){return this.resolveTemplateElements(t).each(function(){var t=this.firstElementChild,e=l.select(t);t.__d3t7tn__.render(e,r)}),this},s.prototype.render=function(){},s.prototype.resolveToRenderElement=function(t){return this.templatePath.resolve(t)},s.prototype.getDataFunction=function(){return this.dataFunction},((v.prototype=Object.create(s.prototype)).constructor=v).prototype.render=function(t,e){var r=this.resolveToRenderElement(t);e&&(r=r.transition(e));var a=this.getDataFunction();a.isTweenFunction?e?r.tween("text",function(e,r,n){var i=l.select(this),o=this;return function(t){i.text(a.call(o,e,r,n)(t))}}):r.text(function(t,e,r){return a.call(this,t,e,r)(1)}):r.text(a)},((y.prototype=Object.create(s.prototype)).constructor=y).prototype.render=function(t,e){var r=this.resolveToRenderElement(t);e&&(r=r.transition(e));var n=this.getDataFunction();n.isTweenFunction?e?r.attrTween(this.attribute,n):r.attr(this.attribute,function(t,e,r){return n.call(this,t,e,r)(1)}):r.attr(this.attribute,n)},((g.prototype=Object.create(s.prototype)).constructor=g).prototype.render=function(t,e){var r=this.resolveToRenderElement(t);e&&(r=r.transition(e));var n=this.getDataFunction();n.isTweenFunction?e?r.styleTween(this.style,n):r.style(this.style,function(t,e,r){return n.call(this,t,e,r)(1)}):r.style(this.style,n)},((_.prototype=Object.create(s.prototype)).constructor=_).prototype.render=function(t,e){var r=this.resolveToRenderElement(t),a=this.getDataFunction();if(a.isTweenFunction)if(e){var s=this.property;e.tween(s,function(e,r,n){var i=l.select(this),o=this;return function(t){i.property(s,a.call(o,e,r,n)(t))}})}else r.property(this.property,function(t,e,r){return a.call(this,t,e,r)(1)});else r.property(this.property,a)};var E={repeatAttribute:"data-repeat",ifAttribute:"data-if",withAttribute:"data-with",importAttribute:"data-import",indirectAttributePrefix:"data-attr-",indirectStylePrefix:"data-style-",indirectPropertyPrefix:"data-prop-"},w="";try{new RegExp(".*","u").unicode&&(w="u")}catch(t){}function b(){return this.children}var x=new RegExp("^\\s*\\{\\{\\s*(.*)\\s*\\}\\}\\s*$",w),T={};function A(t,r){return(r=Object.assign({},E,r||{})).indirectAttributeRegEx=new RegExp("^"+r.indirectAttributePrefix+"(.*)$",w),r.indirectStyleRegEx=new RegExp("^"+r.indirectStylePrefix+"(.*)$",w),r.indirectPropertyRegEx=new RegExp("^"+r.indirectPropertyPrefix+"(.*)$",w),t.each(function(){var t=l.select(this);if(p.getTemplateNode(t))throw new Error("Templates should not overlap. Use 'import' here.");var e=new p(t);new F(r).parse(t,e)}),t}function D(t,e){var r=void 0!==t.duration?t:null;return t.each(function(){var t=l.select(this);if(!p.isTemplateNode(t))throw new Error("Method render() called on non-template selection.");p.getTemplateNode(t).renderData(e,t,r)}),t}function F(t){this.options=t}["attributeName","attributeType","baseFrequency","baseProfile","calcMode","clipPathUnits","contentScriptType","contentStyleType","diffuseConstant","edgeMode","externalResourcesRequired","filterRes","filterUnits","glyphRef","gradientTransform","gradientUnits","hatchContentUnits","hatchUnits","kernelMatrix","kernelUnitLength","keyPoints","keySplines","keyTimes","lengthAdjust","limitingConeAngle","markerHeight","markerUnits","markerWidth","maskContentUnits","maskUnits","numOctaves","pathLength","patternContentUnits","patternTransform","patternUnits","pointsAtX","pointsAtY","pointsAtZ","preserveAlpha","preserveAspectRatio","primitiveUnits","refX","refY","repeatCount","repeatDur","requiredExtensions","requiredFeatures","specularConstant","specularExponent","spreadMethod","startOffset","stdDeviation","stitchTiles","surfaceScale","systemLanguage","tableValues","targetX","targetY","textLength","viewBox","viewTarget","xChannelSelector","yChannelSelector","zoomAndPan"].forEach(function(t){T[t.toLowerCase()]=t}),F.getAttributesFor=function(t){var e=[];if(t.node().hasAttributes())for(var r=t.node().attributes,n=0;n<r.length;n++){var i,o,a=r[n].name,s=a.indexOf(":");i=0<=s?(o=a.slice(0,s),a.slice(s+1)):(o=void 0,a),e.push({prefix:o,localName:i,name:a,value:r[n].value})}return e},F.createDataFunction=function(e){var t,r=!1;e.startsWith("tween:")&&(r=!0,e=e.slice(6).trim());try{var n="return "+e.trim();t=new Function("d","i","nodes",n)}catch(t){throw new Error('Invalid expression "'+e+'". Error: '+t.message)}return r&&(t.isTweenFunction=!0),t},F.prototype.parse=function(t,e){if(p.isTemplateNode(t)&&p.getTemplateNode(t)!==e)throw new Error("Templates should not overlap. Use 'import' here.");this.parseGroupingNodes(t,e),this.parseAttributeRenderers(t,e),this.parseTextRenderers(t,e);var r=this;t.selectAll(b).each(function(){var t=l.select(this);r.parse(t,e)})},F.prototype.parseGroupingNodes=function(r,t){var e=[{attr:this.options.repeatAttribute,nodeClass:c,match:!1},{attr:this.options.ifAttribute,nodeClass:d,match:!1},{attr:this.options.withAttribute,nodeClass:f,match:!1},{attr:this.options.importAttribute,nodeClass:m,match:!1}],n=e[2],i=e[3];if(e.forEach(function(t){var e=r.attr(t.attr);e&&(t.match=e.match(x))}),1<(e=e.filter(function(t){return t!==i&&t.match})).length)throw new Error("A repeat, if or with grouping can't be combined on same element. Wrap one in the other.");if(i.match){if(1===e.length&&!n.match)throw new Error("A repeat or if grouping can't be combined with import on the same element. Wrap one in the other.");if(0<r.node().children.length)throw new Error("No child elements allowed within an import grouping.");if(0!==r.text().trim().length)throw new Error("No text allowed within an import grouping.");i.importSelector=i.match[1],i.match=n.match?n.match:["{{d}}","d"],e=[i]}if(1===e.length){var o=r.select(function(){return this.firstElementChild}).remove();if(0===o.size()&&0!==r.text().trim().length)throw new Error("A child element should be present within repeat, if or with grouping. Wrap text in a DOM element.");if(0<r.node().children.length)throw new Error("Only a single child element allowed within repeat, if or with grouping. Wrap child elements in a container element.");i.importSelector&&(o=F.createDataFunction(i.importSelector));var a=e[0],s=new a.nodeClass(r,F.createDataFunction(a.match[1]),o);t.addChildNode(s),r.attr(a.attr,null),n.match&&r.attr(n.attr,null),i.importSelector||1===o.size()&&(this.parse(o,s),s.storeEventHandlers(o))}},F.prototype.parseAttributeRenderers=function(a,s){var t=F.getAttributesFor(a),c=this.options;t.forEach(function(t){var e=t.value.match(x);if(e){var r=y,n=t.localName,i=n.match(c.indirectAttributeRegEx);if(i){if(n=i[1],void 0!==a.node().ownerSVGElement){var o=T[n];o&&(n=o)}}else(i=n.match(c.indirectStyleRegEx))?(n=i[1],r=g):(i=n.match(c.indirectPropertyRegEx))&&(n=i[1],r=_);t.prefix&&(n=t.prefix+":"+n),s.addRenderer(new r(a,F.createDataFunction(e[1]),n)),i&&t.prefix?a.node().removeAttribute(t.name):a.attr(t.name,null)}})},F.prototype.parseTextRenderers=function(t,e){if(0===t.node().children.length){var r=t.text().match(x);if(r){var n=new v(t,F.createDataFunction(r[1]));e.addRenderer(n),t.text(null)}}},l.selection.prototype.template=function(t){return A(this,t)},l.selection.prototype.render=function(t){return D(this,t)},e.transition.prototype.render=function(t){var e=this;return this.on("start.d3t7",function(){D(e,t)}),this},t.render=D,t.template=A,Object.defineProperty(t,"__esModule",{value:!0})});
